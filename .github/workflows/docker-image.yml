name: Docker Image CI

on:
  push:
    branches: [ "pipeline" ]
  pull_request:
    branches: [ "pipeline" ]

jobs:
#  build:
#    runs-on: ubuntu-latest
#    name: "Build & Test"
#
#    steps:
#    - uses: actions/checkout@v4
#    - name: "Build"
#      run: |
#        go build
#    - name: "Test"
#      run:
#        go test -v
  trivyScan:
    name: Scan for Vulnerabilities
    runs-on: ubuntu-20.04
#    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build an image from Dockerfile
        run: |
          docker build -t seidlfs/my-hello:${{ github.sha }} .
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: 'seidlfs/my-hello:${{ github.sha }} '
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
  publish:
    runs-on: ubuntu-latest
    name: "Build and Publish Docker Image"
    needs: trivyScan

    steps:
    - uses: actions/checkout@v4
    - name: Generate Image Tag
      id: vars
      run: echo "sha_short='$(git rev-parse --short HEAD)'" >> $GITHUB_OUTPUT
    - name: Build the Docker image
      env:
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        GIT_SHA="$(git rev-parse --short HEAD)"
        docker build . --file Dockerfile --tag seidlfs/my-hello:latest
        docker tag seidlfs/my-hello:latest seidlfs/my-hello:$GIT_SHA
        echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_USERNAME --password-stdin
        docker image push seidlfs/my-hello:$GIT_SHA
        docker image push seidlfs/my-hello:latest

        
        
